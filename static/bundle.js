(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){(function(){var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.5.2";var each=_.each=_.forEach=function(obj,iterator,context){if(obj==null)return;if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else if(obj.length===+obj.length){for(var i=0,length=obj.length;i<length;i++){if(iterator.call(context,obj[i],i,obj)===breaker)return}}else{var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){if(iterator.call(context,obj[keys[i]],keys[i],obj)===breaker)return}}};_.map=_.collect=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeMap&&obj.map===nativeMap)return obj.map(iterator,context);each(obj,function(value,index,list){results.push(iterator.call(context,value,index,list))});return results};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduce&&obj.reduce===nativeReduce){if(context)iterator=_.bind(iterator,context);return initial?obj.reduce(iterator,memo):obj.reduce(iterator)}each(obj,function(value,index,list){if(!initial){memo=value;initial=true}else{memo=iterator.call(context,memo,value,index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];if(nativeReduceRight&&obj.reduceRight===nativeReduceRight){if(context)iterator=_.bind(iterator,context);return initial?obj.reduceRight(iterator,memo):obj.reduceRight(iterator)}var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length}each(obj,function(value,index,list){index=keys?keys[--length]:--length;if(!initial){memo=obj[index];initial=true}else{memo=iterator.call(context,memo,obj[index],index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.find=_.detect=function(obj,iterator,context){var result;any(obj,function(value,index,list){if(iterator.call(context,value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeFilter&&obj.filter===nativeFilter)return obj.filter(iterator,context);each(obj,function(value,index,list){if(iterator.call(context,value,index,list))results.push(value)});return results};_.reject=function(obj,iterator,context){return _.filter(obj,function(value,index,list){return!iterator.call(context,value,index,list)},context)};_.every=_.all=function(obj,iterator,context){iterator||(iterator=_.identity);var result=true;if(obj==null)return result;if(nativeEvery&&obj.every===nativeEvery)return obj.every(iterator,context);each(obj,function(value,index,list){if(!(result=result&&iterator.call(context,value,index,list)))return breaker});return!!result};var any=_.some=_.any=function(obj,iterator,context){iterator||(iterator=_.identity);var result=false;if(obj==null)return result;if(nativeSome&&obj.some===nativeSome)return obj.some(iterator,context);each(obj,function(value,index,list){if(result||(result=iterator.call(context,value,index,list)))return breaker});return!!result};_.contains=_.include=function(obj,target){if(obj==null)return false;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;return any(obj,function(value){return value===target})};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,function(value){return value[key]})};_.where=function(obj,attrs,first){if(_.isEmpty(attrs))return first?void 0:[];return _[first?"find":"filter"](obj,function(value){for(var key in attrs){if(attrs[key]!==value[key])return false}return true})};_.findWhere=function(obj,attrs){return _.where(obj,attrs,true)};_.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.max.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return-Infinity;var result={computed:-Infinity,value:-Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed>result.computed&&(result={value:value,computed:computed})});return result.value};_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535){return Math.min.apply(Math,obj)}if(!iterator&&_.isEmpty(obj))return Infinity;var result={computed:Infinity,value:Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed<result.computed&&(result={value:value,computed:computed})});return result.value};_.shuffle=function(obj){var rand;var index=0;var shuffled=[];each(obj,function(value){rand=_.random(index++);shuffled[index-1]=shuffled[rand];shuffled[rand]=value});return shuffled};_.sample=function(obj,n,guard){if(arguments.length<2||guard){return obj[_.random(obj.length-1)]}return _.shuffle(obj).slice(0,Math.max(0,n))};var lookupIterator=function(value){return _.isFunction(value)?value:function(obj){return obj[value]}};_.sortBy=function(obj,value,context){var iterator=lookupIterator(value);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator.call(context,value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,value,context){var result={};var iterator=value==null?_.identity:lookupIterator(value);each(obj,function(value,index){var key=iterator.call(context,value,index,obj);behavior(result,key,value)});return result}};_.groupBy=group(function(result,key,value){(_.has(result,key)?result[key]:result[key]=[]).push(value)});_.indexBy=group(function(result,key,value){result[key]=value});_.countBy=group(function(result,key){_.has(result,key)?result[key]++:result[key]=1});_.sortedIndex=function(array,obj,iterator,context){iterator=iterator==null?_.identity:lookupIterator(iterator);var value=iterator.call(context,obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;iterator.call(context,array[mid])<value?low=mid+1:high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return obj.length===+obj.length?obj.length:_.keys(obj).length};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;return n==null||guard?array[0]:slice.call(array,0,n)};_.initial=function(array,n,guard){return slice.call(array,0,array.length-(n==null||guard?1:n))};_.last=function(array,n,guard){if(array==null)return void 0;if(n==null||guard){return array[array.length-1]}else{return slice.call(array,Math.max(array.length-n,0))}};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,output){if(shallow&&_.every(input,_.isArray)){return concat.apply(output,input)}each(input,function(value){if(_.isArray(value)||_.isArguments(value)){shallow?push.apply(output,value):flatten(value,shallow,output)}else{output.push(value)}});return output};_.flatten=function(array,shallow){return flatten(array,shallow,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iterator,context){if(_.isFunction(isSorted)){context=iterator;iterator=isSorted;isSorted=false}var initial=iterator?_.map(array,iterator,context):array;var results=[];var seen=[];each(initial,function(value,index){if(isSorted?!index||seen[seen.length-1]!==value:!_.contains(seen,value)){seen.push(value);results.push(array[index])}});return results};_.union=function(){return _.uniq(_.flatten(arguments,true))};_.intersection=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,function(other){return _.indexOf(other,item)>=0})})};_.difference=function(array){var rest=concat.apply(ArrayProto,slice.call(arguments,1));return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){var length=_.max(_.pluck(arguments,"length").concat(0));var results=new Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(arguments,""+i)}return results};_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,length=list.length;i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,length=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,length+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item,isSorted);for(;i<length;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var hasIndex=from!=null;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf){return hasIndex?array.lastIndexOf(item,from):array.lastIndexOf(item)}var i=hasIndex?from:array.length;while(i--)if(array[i]===item)return i;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=arguments[2]||1;var length=Math.max(Math.ceil((stop-start)/step),0);var idx=0;var range=new Array(length);while(idx<length){range[idx++]=start;start+=step}return range};var ctor=function(){};_.bind=function(func,context){var args,bound;if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError;args=slice.call(arguments,2);return bound=function(){if(!(this instanceof bound))return func.apply(context,args.concat(slice.call(arguments)));ctor.prototype=func.prototype;var self=new ctor;ctor.prototype=null;var result=func.apply(self,args.concat(slice.call(arguments)));if(Object(result)===result)return result;return self}};_.partial=function(func){var args=slice.call(arguments,1);return function(){return func.apply(this,args.concat(slice.call(arguments)))}};_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length===0)throw new Error("bindAll must be passed function names");each(funcs,function(f){obj[f]=_.bind(obj[f],obj)});return obj};_.memoize=function(func,hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait,options){var context,args,result;var timeout=null;var previous=0;options||(options={});var later=function(){previous=options.leading===false?0:new Date;timeout=null;result=func.apply(context,args)};return function(){var now=new Date;if(!previous&&options.leading===false)previous=now;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args)}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result;return function(){context=this;args=arguments;timestamp=new Date;var later=function(){var last=new Date-timestamp;if(last<wait){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate)result=func.apply(context,args)}};var callNow=immediate&&!timeout;if(!timeout){timeout=setTimeout(later,wait)}if(callNow)result=func.apply(context,args);return result}};_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;memo=func.apply(this,arguments);func=null;return memo}};_.wrap=function(func,wrapper){return function(){var args=[func];push.apply(args,arguments);return wrapper.apply(this,args)}};_.compose=function(){var funcs=arguments;return function(){var args=arguments;for(var i=funcs.length-1;i>=0;i--){args=[funcs[i].apply(this,args)]}return args[0]}};_.after=function(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}};_.keys=nativeKeys||function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)if(_.has(obj,key))keys.push(key);return keys};_.values=function(obj){var keys=_.keys(obj);var length=keys.length;var values=new Array(length);for(var i=0;i<length;i++){values[i]=obj[keys[i]]}return values};_.pairs=function(obj){var keys=_.keys(obj);var length=keys.length;var pairs=new Array(length);for(var i=0;i<length;i++){pairs[i]=[keys[i],obj[keys[i]]]}return pairs};_.invert=function(obj){var result={};var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i]}return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){obj[prop]=source[prop]}}});return obj};_.pick=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));each(keys,function(key){if(key in obj)copy[key]=obj[key]});return copy};_.omit=function(obj){var copy={};var keys=concat.apply(ArrayProto,slice.call(arguments,1));for(var key in obj){if(!_.contains(keys,key))copy[key]=obj[key]}return copy};_.defaults=function(obj){each(slice.call(arguments,1),function(source){if(source){for(var prop in source){if(obj[prop]===void 0)obj[prop]=source[prop]}}});return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!=toString.call(b))return false;switch(className){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]==a)return bStack[length]==b}var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)){return false}aStack.push(a);bStack.push(b);var size=0,result=true;if(className=="[object Array]"){size=a.length;result=size==b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{for(var key in a){if(_.has(a,key)){size++;if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}if(result){for(key in b){if(_.has(b,key)&&!size--)break}result=!size}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)=="[object Array]"};_.isObject=function(obj){return obj===Object(obj)};each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)=="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return!!(obj&&_.has(obj,"callee"))}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj==="function"}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)=="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.times=function(n,iterator,context){var accum=Array(Math.max(0,n));for(var i=0;i<n;i++)accum[i]=iterator.call(context,i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};var entityMap={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(entityMap.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(method){_[method]=function(string){if(string==null)return"";return(""+string).replace(entityRegexes[method],function(match){return entityMap[method][match]})}});_.result=function(object,property){if(object==null)return void 0;var value=object[property];return _.isFunction(value)?value.call(object):value};_.mixin=function(obj){each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\t|\u2028|\u2029/g;_.template=function(text,data,settings){var render;settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,function(match){return"\\"+escapes[match]});if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}if(evaluate){source+="';\n"+evaluate+"\n__p+='"}index=offset+match.length;return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}if(data)return render(data,_);var template=function(data){return render.call(this,data,_)};template.source="function("+(settings.variable||"obj")+"){\n"+source+"}";return template};_.chain=function(obj){return _(obj).chain()};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin(_);each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name=="shift"||name=="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.extend(_.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this)},{}],2:[function(require,module,exports){var AnimatedSprite,Collision,ColorBox,CreatedAt,Enemy,Health,Lifetime,MoveTowardPlayer,Player,PlayerControl,Position,Spellcaster,StaticSprite,StopsAfter,Turnable,Velocity;Position=function(){function Position(pos){this.pos=pos!=null?pos:[0,0]}return Position}();StaticSprite=function(){function StaticSprite(url,pos,size){this.url=url!=null?url:"resources/sun.gif";this.pos=pos!=null?pos:[0,0];this.size=size!=null?size:[128,128]}return StaticSprite}();AnimatedSprite=function(){function AnimatedSprite(url,pos,size,speed,dir,once,frameIndices){this.url=url!=null?url:"resources/sun.gif";this.pos=pos!=null?pos:[0,0];this.size=size!=null?size:[128,128];this.speed=speed!=null?speed:1;this.dir=dir!=null?dir:"vertical";this.once=once!=null?once:false;this.frameIndices=frameIndices!=null?frameIndices:[0];this.index=0}return AnimatedSprite}();ColorBox=function(){function ColorBox(size,color){this.size=size!=null?size:[50,50];this.color=color!=null?color:"red"}return ColorBox}();Velocity=function(){function Velocity(vector){this.vector=vector!=null?vector:[0,0]}return Velocity}();PlayerControl=function(){function PlayerControl(playerSpeed){this.playerSpeed=playerSpeed!=null?playerSpeed:100}return PlayerControl}();Turnable=function(){function Turnable(sprites){this.sprites=sprites}return Turnable}();CreatedAt=function(){function CreatedAt(){this.createdAt=Date.now()}return CreatedAt}();StopsAfter=function(){function StopsAfter(time){this.time=time!=null?time:1e3}return StopsAfter}();Lifetime=function(){function Lifetime(lifetime){this.lifetime=lifetime!=null?lifetime:10}return Lifetime}();Player=function(){function Player(){}return Player}();Enemy=function(){function Enemy(){}return Enemy}();MoveTowardPlayer=function(){function MoveTowardPlayer(speed){this.speed=speed!=null?speed:10}return MoveTowardPlayer}();Collision=function(){function Collision(shouldCollide,didCollide,boundingBoxSize){this.shouldCollide=shouldCollide!=null?shouldCollide:function(){return true};this.didCollide=didCollide!=null?didCollide:function(){};this.boundingBoxSize=boundingBoxSize!=null?boundingBoxSize:[50,50]}return Collision}();Spellcaster=function(){function Spellcaster(spells){this.spells=spells;this.active=0}return Spellcaster}();Health=function(){function Health(hp,maxHp){this.hp=hp;this.maxHp=maxHp}return Health}();exports.Position=Position;exports.StaticSprite=StaticSprite;exports.AnimatedSprite=AnimatedSprite;exports.ColorBox=ColorBox;exports.Velocity=Velocity;exports.PlayerControl=PlayerControl;exports.Turnable=Turnable;exports.CreatedAt=CreatedAt;exports.StopsAfter=StopsAfter;exports.Lifetime=Lifetime;exports.Player=Player;exports.MoveTowardPlayer=MoveTowardPlayer;exports.Collision=Collision;exports.Spellcaster=Spellcaster;exports.Enemy=Enemy;exports.Health=Health},{}],3:[function(require,module,exports){var CollisionSystem,Engine,LifetimeSystem,MoveTowardPlayerSystem,PhysicsSystem,PlayerControlSystem,Renderer,Resources,SpellcastingSystem,SpriteTurningSystem,StopAfterSystem,components,createEnemy,createEngine,engineTick,vecutil,_,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};_=require("underscore");Engine=require("./engine.coffee");Renderer=require("./renderer.coffee");Resources=require("./resources.coffee");components=require("./components.coffee");vecutil=require("./vecutil.coffee");PlayerControlSystem=require("./systems/playerControl.coffee");SpriteTurningSystem=require("./systems/spriteTurning.coffee");StopAfterSystem=require("./systems/stopAfter.coffee");PhysicsSystem=require("./systems/physics.coffee");LifetimeSystem=require("./systems/lifetime.coffee");MoveTowardPlayerSystem=require("./systems/moveTowardPlayer.coffee");CollisionSystem=require("./systems/collision.coffee");SpellcastingSystem=require("./systems/spellcasting.coffee");createEnemy=function(position){var enemyDidCollide,enemyShouldCollide;enemyShouldCollide=function(me,them){return _.has(them.components,"player")};enemyDidCollide=_.throttle(function(me,them){me.components.colorbox.color="green";if(_.has(them.components,"health")){return them.components.health.hp-=1}},100,{trailing:false});return engine.createEntity([new components.Position(position),new components.ColorBox([50,50],"magenta"),new components.Velocity,new components.MoveTowardPlayer(10),new components.Collision(enemyShouldCollide,enemyDidCollide),new components.Enemy])};engineTick=function(dt){var pos;if(Math.random()<dt&&Math.random()<.5){pos=vecutil.alongPerimeter([[0,0],vecutil.sub2d([canvas.width,canvas.height],[20,20])],Math.random());return createEnemy(pos)}};createEngine=function(canvas){var engine;window.canvas=canvas;engine=new Engine(engineTick);window.renderer=new Renderer(canvas);engine.addSystem(renderer.system);engine.beforeTick=renderer.clearCanvas;engine.afterTick=renderer.drawFramerate;window.collisionSystem=new CollisionSystem([canvas.width,canvas.height]);engine.addSystem(collisionSystem);engine.addSystem(new PhysicsSystem);engine.addSystem(new PlayerControlSystem);engine.addSystem(new SpriteTurningSystem);engine.addSystem(new StopAfterSystem);engine.addSystem(new LifetimeSystem);engine.addSystem(new MoveTowardPlayerSystem);engine.addSystem(new SpellcastingSystem);Resources.onReady(function(){var Fireball,Spell,player;engine.start();Spell=function(){function Spell(iconUrl,castDelay){this.iconUrl=iconUrl;this.castDelay=castDelay;this.timer=this.castDelay}Spell.prototype.update=function(dt){return this.timer+=dt};Spell.prototype.canCast=function(){return this.timer>=this.castDelay};Spell.prototype.didCast=function(){return this.timer=0};return Spell}();Fireball=function(_super){__extends(Fireball,_super);function Fireball(){this.cast=__bind(this.cast,this);Fireball.__super__.constructor.call(this,"resources/fireball.jpeg",10)}Fireball.prototype.cast=function(caster,target){var didCollide,shouldCollide,speed,vector;if(!this.canCast()){return}speed=300;vector=vecutil.sub2d(target,caster.components.position.pos);vector=vecutil.scaleTo(vector,speed);shouldCollide=function(me,them){return _.has(them.components,"enemy")};didCollide=function(me,them){me.destroy();return them.destroy()};engine.createEntity([new components.Position(caster.components.position.pos.slice(0)),new components.ColorBox([20,20],"red"),new components.Velocity(vector),new components.Collision(shouldCollide,didCollide,[20,20]),new components.Lifetime(5)]);return this.didCast()};return Fireball}(Spell);return player=engine.createEntity([new components.Position([canvas.width/2,canvas.height/2]),new components.ColorBox([50,50],"blue"),new components.Velocity,new components.PlayerControl,new components.Player,new components.Health(25,25),new components.Collision,new components.Spellcaster([new Fireball])])});Resources.load(["resources/sun.gif","resources/dragonsprites.gif","resources/fireball.jpeg"]);return engine};window.createEngine=createEngine},{"./components.coffee":2,"./engine.coffee":4,"./renderer.coffee":8,"./resources.coffee":9,"./systems/collision.coffee":11,"./systems/lifetime.coffee":12,"./systems/moveTowardPlayer.coffee":13,"./systems/physics.coffee":14,"./systems/playerControl.coffee":15,"./systems/spellcasting.coffee":16,"./systems/spriteTurning.coffee":17,"./systems/stopAfter.coffee":18,"./vecutil.coffee":20,underscore:1}],4:[function(require,module,exports){var Engine,Entity,util,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};util=require("./util.coffee");Entity=require("./entity.coffee");Engine=function(){function Engine(tickFunction){this.tickFunction=tickFunction;this.gameLoop=__bind(this.gameLoop,this);this.entities={};this.systems=[];this.lastEntityId=0;this.running=false;this.lastFrameTime=null}Engine.prototype.createEntity=function(components){var c,componentsObject,entity,id,system,_i,_j,_len,_len1,_ref;componentsObject={};for(_i=0,_len=components.length;_i<_len;_i++){c=components[_i];componentsObject[util.keyForComponent(c)]=c}id=this.lastEntityId;entity=new Entity(id,componentsObject,this);this.entities[id]=entity;_ref=this.systems;for(_j=0,_len1=_ref.length;_j<_len1;_j++){system=_ref[_j];system.updateCache(entity)}this.lastEntityId+=1;return entity};Engine.prototype.updateEntity=function(entity){var system,_i,_len,_ref,_results;_ref=this.systems;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){system=_ref[_i];_results.push(system.updateCache(entity))}return _results};Engine.prototype.addSystem=function(system){this.systems.push(system);return system.buildCache(this.entities)};Engine.prototype.tick=function(dt){var system,_i,_len,_ref;_ref=this.systems;for(_i=0,_len=_ref.length;_i<_len;_i++){system=_ref[_i];system.run(this.entities,dt)}return this.tickFunction.call(this,dt)};Engine.prototype.removeDeadEntities=function(){var entity,id,system,_i,_len,_ref,_ref1,_results;_ref=this.entities;_results=[];for(id in _ref){entity=_ref[id];if(entity.components.destroy!=null){entity.components=null;_ref1=this.systems;for(_i=0,_len=_ref1.length;_i<_len;_i++){system=_ref1[_i];system.updateCache(entity)}_results.push(delete this.entities[id])}else{_results.push(void 0)}}return _results};Engine.prototype.start=function(){this.running=true;this.lastFrameTime=null;return requestAnimationFrame(this.gameLoop)};Engine.prototype.stop=function(){return this.running=false};Engine.prototype.reset=function(){var system,_i,_len,_ref;if(this.rafId!=null){cancelAnimationFrame(this.rafId)}this.entities={};_ref=this.systems;for(_i=0,_len=_ref.length;_i<_len;_i++){system=_ref[_i];system.buildCache()}return this.start()};Engine.prototype.gameLoop=function(paintTime){var dt;if(this.lastFrameTime===null){this.lastFrameTime=paintTime}else{dt=(paintTime-this.lastFrameTime)/1e3;this.lastFrameTime=paintTime;if(typeof this.beforeTick==="function"){this.beforeTick(dt)}this.tick(dt);this.removeDeadEntities();if(typeof this.afterTick==="function"){this.afterTick(dt)}renderer.ctx.strokeText(Object.keys(this.entities).length,400,100)}if(this.running){return this.rafId=requestAnimationFrame(this.gameLoop)}};return Engine}();module.exports=Engine},{"./entity.coffee":5,"./util.coffee":19}],5:[function(require,module,exports){var Entity,util,_;_=require("underscore");util=require("./util.coffee");Entity=function(){function Entity(id,components,engine){this.id=id;this.components=components;this.engine=engine}Entity.prototype.addComponent=function(component){var componentObject;if(this.components){componentObject={};componentObject[util.keyForComponent(component)]=component;
_.extend(this.components,componentObject);return this.engine.updateEntity(this)}};Entity.prototype.removeComponent=function(componentName){if(this.components){if(_.has(this.components,componentName)){delete this.components[componentName];return this.engine.updateEntity(this)}}};Entity.prototype.destroy=function(){return this.components.destroy=true};Entity.prototype.toJSON=function(){return{id:this.id,components:this.components}};return Entity}();module.exports=Entity},{"./util.coffee":19,underscore:1}],6:[function(require,module,exports){var Input;Input=function(){var keys,mouse,setKey;keys={};setKey=function(event,status){var code,key;code=event.keyCode;key=function(){switch(code){case 32:return"SPACE";case 37:return"LEFT";case 38:return"UP";case 39:return"RIGHT";case 40:return"DOWN";case 187:return"+";case 189:return"-";default:return String.fromCharCode(code)}}();return keys[key]=status};document.addEventListener("keydown",function(e){return setKey(e,true)});document.addEventListener("keyup",function(e){return setKey(e,false)});document.addEventListener("blur",function(){return keys={}});mouse={isDown:false,pos:[0,0],posRelativeTo:function(element){var rect;rect=element.getBoundingClientRect();return[this.pos[0]-rect.left,this.pos[1]-rect.top]}};document.addEventListener("mousemove",function(e){mouse.pos[0]=e.x;return mouse.pos[1]=e.y});document.addEventListener("mousedown",function(e){return mouse.isDown=true});document.addEventListener("mouseup",function(e){return mouse.isDown=false});return{isDown:function(key){return keys[key.toUpperCase()]},mouse:mouse}}();module.exports=Input},{}],7:[function(require,module,exports){var BoundNode,BoundQuadTree,Node,QuadTree,qTreeUniq,rectCenter,rectCorners,rectIntersect,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};rectCenter=function(rect){return[rect.x+rect.width/2,rect.y+rect.height/2]};rectCorners=function(rect){return[[x,y],[x+width,y],[x,y+height],[x+width,y+height]]};rectIntersect=function(rect1,rect2){return Math.abs(rect1.x+rect1.width/2-rect2.x-rect2.width/2)*2<rect1.width+rect2.width&&Math.abs(rect1.y+rect1.height/2-rect2.y-rect2.height/2)*2<rect1.height+rect2.height};qTreeUniq=function(arr){var seen,uniques,x,_i,_len;seen={};uniques=[];for(_i=0,_len=arr.length;_i<_len;_i++){x=arr[_i];if(!seen[x._qtreeid]){uniques.push(x);seen[x._qtreeid]=true}}return uniques};Node=function(){var NE,NW,SE,SW;NE=0;NW=1;SW=2;SE=3;function Node(rect,depth,maxDepth,maxChildren){this.rect=rect;this.depth=depth;this.maxDepth=maxDepth;this.maxChildren=maxChildren;this.children=[];this.nodes=[];this.myClass=Node;this.nextId=0}Node.prototype._bin=function(item){var center;center=rectCenter(this.rect);if(item.x<center[0]){if(item.y<center[1]){return NW}else{return SW}}else{if(item.y<center[1]){return NE}else{return SE}}};Node.prototype.insert=function(item){var _i,_len,_ref;item._qtreeid=this.nextId++;if(this.nodes.length){return this.nodes[this._bin(item)].insert(item)}else{this.children.push(item);if(this.children.length>this.maxChildren&&this.depth<this.maxDepth){this.subdivide();_ref=this.children;for(_i=0,_len=_ref.length;_i<_len;_i++){item=_ref[_i];this.insert(item)}return this.children.length=0}}};Node.prototype.retrieve=function(item){if(this.nodes.length){return this.nodes[this._bin(item)].retrieve(item)}else{return this.children}};Node.prototype.subdivide=function(){var centerX,centerY,halfHeight,halfWidth,_ref;halfWidth=this.rect.width/2;halfHeight=this.rect.height/2;_ref=rectCenter(this.rect),centerX=_ref[0],centerY=_ref[1];this.nodes[NE]=new this.myClass({x:centerX,y:this.rect.y,width:halfWidth,height:halfHeight},this.depth+1,this.maxDepth,this.maxChildren);this.nodes[NW]=new this.myClass({x:this.rect.x,y:this.rect.y,width:halfWidth,height:halfHeight},this.depth+1,this.maxDepth,this.maxChildren);this.nodes[SW]=new this.myClass({x:this.rect.x,y:centerY,width:halfWidth,height:halfHeight},this.depth+1,this.maxDepth,this.maxChildren);return this.nodes[SE]=new this.myClass({x:centerX,y:centerY,width:halfWidth,height:halfHeight},this.depth+1,this.maxDepth,this.maxChildren)};Node.prototype.clear=function(){var node,_i,_len,_ref;this.children.length=0;_ref=this.nodes;for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];node.clear()}return this.nodes.length=0};return Node}();BoundNode=function(_super){__extends(BoundNode,_super);function BoundNode(rect,depth,maxDepth,maxChildren){BoundNode.__super__.constructor.call(this,rect,depth,maxDepth,maxChildren);this.myClass=BoundNode}BoundNode.prototype.insert=function(item){var node,_i,_j,_len,_len1,_ref,_ref1,_results;if(item._qtreeid===void 0){item._qtreeid=this.nextId++}if(this.nodes.length){_ref=this.nodes;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];if(rectIntersect(node.rect,item)){_results.push(node.insert(item))}else{_results.push(void 0)}}return _results}else{this.children.push(item);if(this.children.length>this.maxChildren&&this.depth<this.maxDepth){this.subdivide();_ref1=this.children;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){item=_ref1[_j];this.insert(item)}return this.children.length=0}}};BoundNode.prototype.retrieve=function(item){var items,node,_i,_len,_ref;if(this.nodes.length){items=[];_ref=this.nodes;for(_i=0,_len=_ref.length;_i<_len;_i++){node=_ref[_i];if(rectIntersect(node.rect,item)){items.push.apply(items,node.retrieve(item))}}return qTreeUniq(items)}else{return this.children}};return BoundNode}(Node);QuadTree=function(){function QuadTree(rect,maxDepth,maxChildren){if(maxDepth==null){maxDepth=10}if(maxChildren==null){maxChildren=10}this.root=new Node(rect,0,maxDepth,maxChildren)}QuadTree.prototype.insert=function(itemOrArray){var item,_i,_len,_results;if(itemOrArray instanceof Array){_results=[];for(_i=0,_len=itemOrArray.length;_i<_len;_i++){item=itemOrArray[_i];_results.push(this.root.insert(item))}return _results}else{return this.root.insert(itemOrArray)}};QuadTree.prototype.clear=function(){return this.root.clear()};QuadTree.prototype.retrieve=function(item){return this.root.retrieve(item).slice(0)};return QuadTree}();BoundQuadTree=function(_super){__extends(BoundQuadTree,_super);function BoundQuadTree(rect,maxDepth,maxChildren){if(maxDepth==null){maxDepth=10}if(maxChildren==null){maxChildren=10}this.root=new BoundNode(rect,0,maxDepth,maxChildren)}return BoundQuadTree}(QuadTree);exports.QuadTree=QuadTree;exports.BoundQuadTree=BoundQuadTree},{}],8:[function(require,module,exports){var Renderer,Resources,system,util,vecutil,_,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__slice=[].slice;_=require("underscore");Resources=require("./resources.coffee");system=require("./system.coffee");util=require("./util.coffee");vecutil=require("./vecutil.coffee");Renderer=function(){function Renderer(canvas){var AnimatedRenderingSystem,ColorBoxRenderingSystem,StaticRenderingSystem,UIRenderingSystem,_this=this;this.canvas=canvas;this.ctx=canvas.getContext("2d");StaticRenderingSystem=function(_super){__extends(StaticRenderingSystem,_super);function StaticRenderingSystem(ctx){this.ctx=ctx;StaticRenderingSystem.__super__.constructor.call(this,["position","staticsprite"])}StaticRenderingSystem.prototype.action=function(entity,dt){var position,staticSprite;position=entity.components.position;staticSprite=entity.components.staticsprite;return this.ctx.drawImage(Resources.get(staticSprite.url),staticSprite.pos[0],staticSprite.pos[1],staticSprite.size[0],staticSprite.size[1],position.pos[0],position.pos[1],staticSprite.size[0],staticSprite.size[1])};return StaticRenderingSystem}(system.BasicSystem);AnimatedRenderingSystem=function(_super){__extends(AnimatedRenderingSystem,_super);function AnimatedRenderingSystem(ctx){this.ctx=ctx;AnimatedRenderingSystem.__super__.constructor.call(this,["position","animatedsprite"])}AnimatedRenderingSystem.prototype.action=function(entity,dt){var animatedSprite,frameIndex,idx,max,position,spritePosition,xySwitch;position=entity.components.position;animatedSprite=entity.components.animatedsprite;if(animatedSprite.speed>0){idx=Math.floor(animatedSprite.index+=animatedSprite.speed*dt);max=animatedSprite.frameIndices.length;frameIndex=animatedSprite.frameIndices[idx%max];if(animatedSprite.once&&idx>max){animatedSprite.done=true;return}}else{frameIndex=0}spritePosition=animatedSprite.pos.slice();xySwitch=animatedSprite.dir==="vertical"?1:0;spritePosition[xySwitch]+=frameIndex*animatedSprite.size[xySwitch];return this.ctx.drawImage(Resources.get(animatedSprite.url),spritePosition[0],spritePosition[1],animatedSprite.size[0],animatedSprite.size[1],position.pos[0],position.pos[1],animatedSprite.size[0],animatedSprite.size[1])};return AnimatedRenderingSystem}(system.BasicSystem);ColorBoxRenderingSystem=function(_super){__extends(ColorBoxRenderingSystem,_super);function ColorBoxRenderingSystem(ctx){this.ctx=ctx;ColorBoxRenderingSystem.__super__.constructor.call(this,["position","colorbox"])}ColorBoxRenderingSystem.prototype.action=function(entity){var colorbox,position;position=entity.components.position;colorbox=entity.components.colorbox;this.ctx.save();this.ctx.setFillColor(colorbox.color);this.ctx.fillRect(position.pos[0],position.pos[1],colorbox.size[0],colorbox.size[1]);return this.ctx.restore()};return ColorBoxRenderingSystem}(system.BasicSystem);UIRenderingSystem=function(_super){__extends(UIRenderingSystem,_super);function UIRenderingSystem(ctx,canvasSize){this.ctx=ctx;this.canvasSize=canvasSize;UIRenderingSystem.__super__.constructor.call(this,["player","health","spellcaster"])}UIRenderingSystem.prototype.action=function(entity){var center,centerTop,completion,corners,cornersIndex,health,height,i,intersectPoint,maxWidth,spell,spellIconSize,spellIconY,spellcaster,theta,topLeft,_i,_len,_ref,_ref1,_ref2;health=entity.components.health;maxWidth=200;height=20;this.ctx.save();this.ctx.setFillColor("red");this.ctx.fillRect(0,0,maxWidth*health.hp/health.maxHp,height);spellcaster=entity.components.spellcaster;spellIconSize=[50,50];spellIconY=this.canvasSize[1]-spellIconSize[1];_ref=spellcaster.spells;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){spell=_ref[i];topLeft=[i*spellIconSize[0],spellIconY];(_ref1=this.ctx).drawImage.apply(_ref1,[Resources.get("resources/fireball.jpeg")].concat(__slice.call(topLeft),__slice.call(spellIconSize)));if(!spell.canCast()){centerTop=vecutil.add2d(topLeft,[spellIconSize[0]/2,0]);center=vecutil.add2d(topLeft,[spellIconSize[0]/2,spellIconSize[1]/2]);corners=vecutil.rectCorners.apply(vecutil,[topLeft].concat(__slice.call(spellIconSize)));corners=util.rotateArray(corners,-1);completion=spell.timer/spell.castDelay;theta=Math.TAU*completion-Math.TAU/8;cornersIndex=Math.floor(theta/(Math.TAU/4))+1;completion=(completion+1/8)%1;intersectPoint=vecutil.alongPerimeter([topLeft,spellIconSize],completion);vecutil.polygon.apply(vecutil,[this.ctx,centerTop,center,intersectPoint].concat(__slice.call(corners.slice(cornersIndex))));this.ctx.setFillColor(0,0,0,.5);this.ctx.fill()}}this.ctx.setLineWidth(2);this.ctx.setStrokeColor("white");(_ref2=this.ctx).strokeRect.apply(_ref2,[spellcaster.active*spellIconSize[0],spellIconY].concat(__slice.call(spellIconSize)));return this.ctx.restore()};return UIRenderingSystem}(system.BasicSystem);this.system=new system.CompsiteSystem(new StaticRenderingSystem(this.ctx),new AnimatedRenderingSystem(this.ctx),new ColorBoxRenderingSystem(this.ctx),new UIRenderingSystem(this.ctx,[canvas.width,canvas.height]));this.clearCanvas=function(dt){_this.ctx.fillStyle="lightgrey";return _this.ctx.fillRect(0,0,_this.canvas.width,_this.canvas.height)};this.drawFramerate=function(dt){if(_this.showFramerate){return _this.updateAndDrawFramerate(dt)}};this.framerates=[];this.showFramerate=true}Renderer.prototype.toggleFramerate=function(){return this.showFramerate=!this.showFramerate};Renderer.prototype.updateAndDrawFramerate=function(dt){var drawFramerate,_this=this;drawFramerate=function(){_this.ctx.save();_this.ctx.fillStyle="black";_this.ctx.font="30px sans-serif";_this.ctx.fillText(util.average(_this.framerates).toFixed(1),50,50);return _this.ctx.restore()};this.framerates.push(1/dt);while(this.framerates.length>10){this.framerates.shift()}return drawFramerate()};Renderer.prototype.drawQuadTreeNode=function(node){var n,rect,_i,_len,_ref;_ref=node.nodes;for(_i=0,_len=_ref.length;_i<_len;_i++){n=_ref[_i];this.drawQuadTreeNode(n)}rect=node.rect;this.ctx.strokeRect(rect.x,rect.y,rect.width,rect.height);return this.ctx.strokeText(node.children.length,rect.x+rect.width/2,rect.y+rect.height/2)};return Renderer}();module.exports=Renderer},{"./resources.coffee":9,"./system.coffee":10,"./util.coffee":19,"./vecutil.coffee":20,underscore:1}],9:[function(require,module,exports){var Resources,_;_=require("underscore");window.imgs=[];Resources=function(){var callbacks,get,load,onReady,ready,resources,_load;resources={};callbacks=[];ready=function(){return _.all(_.values(resources))};_load=function(url){var img;if(resources[url]){return resources[url]}else{img=new Image;window.imgs.push(img);img.onload=function(){var cb,_i,_len,_results;resources[url]=img;if(ready()){_results=[];for(_i=0,_len=callbacks.length;_i<_len;_i++){cb=callbacks[_i];_results.push(cb())}return _results}};resources[url]=false;return _.defer(function(){return img.src=url})}};load=function(urlOrArray){var url,_i,_len,_results;if(urlOrArray instanceof Array){_results=[];for(_i=0,_len=urlOrArray.length;_i<_len;_i++){url=urlOrArray[_i];_results.push(_load(url))}return _results}else{return _load(urlOrArray)}};get=function(url){return resources[url]};onReady=function(callback){callbacks.push(callback);if(ready()&&!_.isEmpty(resources)){return callback()}};return{load:load,get:get,onReady:onReady}}();module.exports=Resources},{underscore:1}],10:[function(require,module,exports){var BasicSystem,CompsiteSystem,System,_,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__slice=[].slice;_=require("underscore");System=function(){function System(){this.cache={}}System.prototype.buildCache=function(entities){var entity,id,_results;this.clearCache();_results=[];for(id in entities){entity=entities[id];_results.push(this.updateCache(entity))}return _results};System.prototype.clearCache=function(){return this.cache={}};System.prototype.updateCache=function(entity){if(!entity.components||!this.satisfies(entity.components)){if(_.has(this.cache,entity.id)){return delete this.cache[entity.id]}}else{return this.cache[entity.id]=true}};System.prototype.run=function(entities,dt){var id,_i,_len,_ref,_results;_ref=_.keys(this.cache);_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){id=_ref[_i];_results.push(this.action(entities[id],dt,entities))}return _results};System.prototype.action=function(entity,dt,entities){};System.prototype.satisfies=function(){return false};return System}();BasicSystem=function(_super){__extends(BasicSystem,_super);function BasicSystem(requiredComponents){this.requiredComponents=requiredComponents;BasicSystem.__super__.constructor.call(this)}BasicSystem.prototype.satisfies=function(components){return _.every(this.requiredComponents,function(required){return _.has(components,required)})};return BasicSystem}(System);CompsiteSystem=function(_super){__extends(CompsiteSystem,_super);function CompsiteSystem(){var systems;systems=1<=arguments.length?__slice.call(arguments,0):[];this.systems=systems}CompsiteSystem.prototype.buildCache=function(entities){var system,_i,_len,_ref,_results;_ref=this.systems;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){system=_ref[_i];_results.push(system.buildCache(entities))}return _results};CompsiteSystem.prototype.updateCache=function(entity){var system,_i,_len,_ref,_results;_ref=this.systems;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){system=_ref[_i];_results.push(system.updateCache(entity))}return _results};CompsiteSystem.prototype.run=function(entities,dt){var system,_i,_len,_ref,_results;_ref=this.systems;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){system=_ref[_i];_results.push(system.run(entities,dt))}return _results};CompsiteSystem.prototype.action=function(entity,dt,entities){var system,_i,_len,_ref,_results;_ref=this.systems;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){system=_ref[_i];_results.push(system.action(entity,dt,entities))}return _results};return CompsiteSystem}(System);exports.BasicSystem=BasicSystem;exports.System=System;exports.CompsiteSystem=CompsiteSystem},{underscore:1}],11:[function(require,module,exports){var CollisionSystem,QuadTree,makeQuadTreeItem,system,vecutil,_,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},__slice=[].slice;_=require("underscore");QuadTree=require("../quadtree.coffee");system=require("../system.coffee");vecutil=require("../vecutil.coffee");makeQuadTreeItem=function(entity){return{x:entity.components.position.pos[0],y:entity.components.position.pos[1],width:entity.components.collision.boundingBoxSize[0],height:entity.components.collision.boundingBoxSize[1],id:entity.id}};CollisionSystem=function(_super){__extends(CollisionSystem,_super);function CollisionSystem(canvasSize){var _this=this;this.canvasSize=canvasSize;CollisionSystem.__super__.constructor.call(this,["collision","position"]);this.quadTree=new QuadTree.BoundQuadTree({x:0,y:0,width:this.canvasSize[0],height:this.canvasSize[1]},5,10);this.shouldDrawQuadTree=false;this.shouldDrawCollisionBoxes=false;document.addEventListener("keypress",function(e){if(e.key==null){e.key=String.fromCharCode(e.charCode)}switch(e.key){case"q":return _this.shouldDrawQuadTree=!_this.shouldDrawQuadTree;case"c":return _this.shouldDrawCollisionBoxes=!_this.shouldDrawCollisionBoxes}})}CollisionSystem.prototype.action=function(entity,dt,entities){var collision,didCollide,item,otherEntity,position,_i,_len,_ref;position=entity.components.position;collision=entity.components.collision;didCollide=false;_ref=this.quadTree.retrieve({x:position.pos[0],y:position.pos[1],width:collision.boundingBoxSize[0],height:collision.boundingBoxSize[1]});for(_i=0,_len=_ref.length;_i<_len;_i++){item=_ref[_i];otherEntity=entities[item.id];if(otherEntity.id!==entity.id){if(vecutil.rectIntersect([position.pos,collision.boundingBoxSize],[otherEntity.components.position.pos,otherEntity.components.collision.boundingBoxSize])){didCollide=true;if(collision.shouldCollide(entity,otherEntity)){collision.didCollide(entity,otherEntity)}}}}if(this.shouldDrawCollisionBoxes){return this.drawCollisionBox(entity,didCollide)}};CollisionSystem.prototype.run=function(entities,dt){var i,_i,_len,_ref;this.quadTree.clear();_ref=_.keys(this.cache);for(_i=0,_len=_ref.length;_i<_len;_i++){i=_ref[_i];this.quadTree.insert(makeQuadTreeItem(entities[i]))}CollisionSystem.__super__.run.call(this,entities,dt);if(this.shouldDrawQuadTree){return this.drawQuadTree()}};CollisionSystem.prototype.drawQuadTree=function(){return renderer.drawQuadTreeNode(this.quadTree.root)};CollisionSystem.prototype.drawCollisionBox=function(entity,colliding){var _ref;renderer.ctx.save();renderer.ctx.setStrokeColor(colliding?"red":"green");(_ref=renderer.ctx).strokeRect.apply(_ref,__slice.call(entity.components.position.pos).concat(__slice.call(entity.components.collision.boundingBoxSize)));return renderer.ctx.restore()};return CollisionSystem}(system.BasicSystem);module.exports=CollisionSystem},{"../quadtree.coffee":7,"../system.coffee":10,"../vecutil.coffee":20,underscore:1}],12:[function(require,module,exports){var LifetimeSystem,system,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};system=require("../system.coffee");LifetimeSystem=function(_super){__extends(LifetimeSystem,_super);function LifetimeSystem(){LifetimeSystem.__super__.constructor.call(this,["lifetime"])}LifetimeSystem.prototype.action=function(entity,dt){entity.components.lifetime.lifetime-=dt;if(entity.components.lifetime.lifetime<=0){return entity.destroy()}};return LifetimeSystem}(system.BasicSystem);module.exports=LifetimeSystem},{"../system.coffee":10}],13:[function(require,module,exports){var MoveTowardPlayerSystem,system,vecutil,_,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};_=require("underscore");system=require("../system.coffee");vecutil=require("../vecutil.coffee");MoveTowardPlayerSystem=function(_super){__extends(MoveTowardPlayerSystem,_super);function MoveTowardPlayerSystem(){MoveTowardPlayerSystem.__super__.constructor.call(this,["velocity","position","movetowardplayer"]);this.player=null}MoveTowardPlayerSystem.prototype.action=function(entity,dt){var direction;if(this.player){direction=vecutil.direction(this.player.components.position.pos,entity.components.position.pos);return entity.components.velocity.vector=vecutil.scale(direction,entity.components.movetowardplayer.speed)}};MoveTowardPlayerSystem.prototype.updateCache=function(entity){var _ref;MoveTowardPlayerSystem.__super__.updateCache.call(this,entity);if(entity.components===null){if(((_ref=this.player)!=null?_ref.id:void 0)===entity.id){return this.player=null}}else{if(_.has(entity.components,"player")){return this.player=entity}}};return MoveTowardPlayerSystem}(system.BasicSystem);module.exports=MoveTowardPlayerSystem},{"../system.coffee":10,"../vecutil.coffee":20,underscore:1}],14:[function(require,module,exports){var PhysicsSystem,system,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};system=require("../system.coffee");PhysicsSystem=function(_super){__extends(PhysicsSystem,_super);function PhysicsSystem(){PhysicsSystem.__super__.constructor.call(this,["position","velocity"])}PhysicsSystem.prototype.action=function(entity,dt){var position,velocity;position=entity.components.position;velocity=entity.components.velocity;position.pos[0]+=velocity.vector[0]*dt;return position.pos[1]+=velocity.vector[1]*dt};return PhysicsSystem}(system.BasicSystem);module.exports=PhysicsSystem},{"../system.coffee":10}],15:[function(require,module,exports){var Input,PlayerControlSystem,system,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Input=require("../input.coffee");system=require("../system.coffee");PlayerControlSystem=function(_super){__extends(PlayerControlSystem,_super);function PlayerControlSystem(){PlayerControlSystem.__super__.constructor.call(this,["playercontrol","velocity"])}PlayerControlSystem.prototype.action=function(entity,dt){var playerSpeed,velocity;velocity=entity.components.velocity;playerSpeed=entity.components.playercontrol.playerSpeed;if(Input.isDown("LEFT")||Input.isDown("a")){velocity.vector[0]=-playerSpeed}else if(Input.isDown("RIGHT")||Input.isDown("d")){velocity.vector[0]=playerSpeed}else{velocity.vector[0]=0}if(Input.isDown("UP")||Input.isDown("w")){return velocity.vector[1]=-playerSpeed}else if(Input.isDown("DOWN")||Input.isDown("s")){return velocity.vector[1]=playerSpeed}else{return velocity.vector[1]=0}};return PlayerControlSystem}(system.BasicSystem);module.exports=PlayerControlSystem},{"../input.coffee":6,"../system.coffee":10}],16:[function(require,module,exports){var Input,SpellcastingSystem,system,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};Input=require("../input.coffee");system=require("../system.coffee");SpellcastingSystem=function(_super){__extends(SpellcastingSystem,_super);function SpellcastingSystem(){SpellcastingSystem.__super__.constructor.call(this,["position","spellcaster"])}SpellcastingSystem.prototype.action=function(entity,dt){var spell,_i,_len,_ref;_ref=entity.components.spellcaster.spells;for(_i=0,_len=_ref.length;_i<_len;_i++){spell=_ref[_i];spell.update(dt)}if(Input.mouse.isDown){return new entity.components.spellcaster.spells[0].cast(entity,Input.mouse.posRelativeTo(canvas))}};return SpellcastingSystem}(system.BasicSystem);module.exports=SpellcastingSystem},{"../input.coffee":6,"../system.coffee":10}],17:[function(require,module,exports){var Input,SpriteTurningSystem,center,system,vecutil,_,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};_=require("underscore");Input=require("../input.coffee");system=require("../system.coffee");vecutil=require("../vecutil.coffee");center=function(components){return vecutil.add2d(components.position.pos,vecutil.scale(_.has(components,"staticsprite")?components.staticsprite.size:_.has(components,"animatedsprite")?components.animatedsprite.size:components.colorbox.size,.5))};SpriteTurningSystem=function(_super){__extends(SpriteTurningSystem,_super);function SpriteTurningSystem(){_ref=SpriteTurningSystem.__super__.constructor.apply(this,arguments);return _ref}SpriteTurningSystem.prototype.satisfies=function(components){return _.has(components,"turnable")&&_.has(components,"position")&&(_.has(components,"staticsprite")||_.has(components,"animatedsprite")||_.has(components,"colorbox"))};SpriteTurningSystem.prototype.action=function(entity,dt){var index,sprite,theta,vector;vector=vecutil.sub2d(Input.mouse.posRelativeTo(canvas),center(entity.components));theta=vecutil.angleOfIncidence(vector);theta+=Math.TAU/16%Math.TAU;index=Math.floor(theta/(Math.TAU/8));sprite=entity.components.turnable.sprites[index];if(sprite!=null){if(_.has(entity.components,"staticsprite")){return components.staticsprite=sprite}else if(_.has(entity.components,"animatedsprite")){return entity.components.animatedsprite=sprite}else{return entity.components.colorbox=sprite}}};return SpriteTurningSystem}(system.System);module.exports=SpriteTurningSystem},{"../input.coffee":6,"../system.coffee":10,"../vecutil.coffee":20,underscore:1}],18:[function(require,module,exports){var StopAfterSystem,system,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};system=require("../system.coffee");StopAfterSystem=function(_super){__extends(StopAfterSystem,_super);function StopAfterSystem(){StopAfterSystem.__super__.constructor.call(this,["velocity","createdat","stopsafter"])}StopAfterSystem.prototype.action=function(entity,dt){if(Date.now()-entity.components.createdat.createdAt>entity.components.stopsafter.time){entity.destroy();entity.components.velocity.vector[0]=0;return entity.components.velocity.vector[1]=0}};return StopAfterSystem}(system.BasicSystem);module.exports=StopAfterSystem},{"../system.coffee":10}],19:[function(require,module,exports){var average,keyForComponent,rotateArray,sum,_;_=require("underscore");sum=function(list){return _.foldl(list,function(s,x){return s+x},0)};average=function(list){return sum(list)/list.length};keyForComponent=function(component){return component.constructor.name.toLowerCase()};rotateArray=function(arr,offset){var i,index,newArr,x,_i,_len;newArr=arr.slice();for(i=_i=0,_len=arr.length;_i<_len;i=++_i){x=arr[i];index=(i+arr.length+offset)%arr.length;newArr[index]=x}return newArr};exports.sum=sum;exports.average=average;exports.keyForComponent=keyForComponent;exports.rotateArray=rotateArray},{underscore:1}],20:[function(require,module,exports){var add2d,alongPerimeter,angleOfIncidence,direction,distance,magnitude,normalize,polygon,rectCorners,rectIntersect,scale,scaleTo,sub2d,__slice=[].slice;Math.TAU=2*Math.PI;magnitude=function(v){return Math.sqrt(v[0]*v[0]+v[1]*v[1])};normalize=function(v){var m;m=magnitude(v);return[v[0]/m,v[1]/m]};add2d=function(v1,v2){return[v1[0]+v2[0],v1[1]+v2[1]]};sub2d=function(v1,v2){return[v1[0]-v2[0],v1[1]-v2[1]]};scale=function(v,s){return[v[0]*s,v[1]*s]};scaleTo=function(v,s){return scale(normalize(v),s)};distance=function(v1,v2){return magnitude(sub2d(v1,v2))};direction=function(to,from){return normalize(sub2d(to,from))};angleOfIncidence=function(v,flipy){var theta;if(flipy==null){flipy=true}theta=Math.atan2(flipy?-v[1]:v[1],v[0]);if(theta<0){theta+=Math.TAU}return theta};Math.radToDeg=function(r){return r/Math.TAU*360};alongPerimeter=function(rect,along){var height,perimeter,width,x,y,_ref,_ref1;_ref=rect[0],x=_ref[0],y=_ref[1],_ref1=rect[1],width=_ref1[0],height=_ref1[1];perimeter=2*(width+height);along=perimeter*along;if(along<width){return[x+along,y]}else if(along<width+height){return[x+width,y+along-width]}else if(along<2*width+height){return[width-(x+along-(width+height)),y+height]}else{return[x,y+(height-(along-2*width-height))]}};rectIntersect=function(rect1,rect2){return Math.abs(rect1[0][0]+rect1[1][0]/2-rect2[0][0]-rect2[1][0]/2)*2<rect1[1][0]+rect2[1][0]&&Math.abs(rect1[0][1]+rect1[1][1]/2-rect2[0][1]-rect2[1][1]/2)*2<rect1[1][1]+rect2[1][1]};polygon=function(){var ctx,point,points,_i,_len,_ref;ctx=arguments[0],points=2<=arguments.length?__slice.call(arguments,1):[];ctx.beginPath();ctx.moveTo.apply(ctx,points[0]);_ref=points.slice(1);for(_i=0,_len=_ref.length;_i<_len;_i++){point=_ref[_i];ctx.lineTo.apply(ctx,point)}return ctx.closePath()};rectCorners=function(topLeft,width,height){return[topLeft,add2d(topLeft,[width,0]),add2d(topLeft,[width,height]),add2d(topLeft,[0,height])]};exports.magnitude=magnitude;exports.normalize=normalize;exports.add2d=add2d;exports.sub2d=sub2d;exports.scale=scale;exports.scaleTo=scaleTo;exports.distance=distance;exports.direction=direction;exports.angleOfIncidence=angleOfIncidence;exports.alongPerimeter=alongPerimeter;exports.rectIntersect=rectIntersect;exports.polygon=polygon;exports.rectCorners=rectCorners},{}]},{},[3]);